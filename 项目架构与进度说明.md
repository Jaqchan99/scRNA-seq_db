# scRNA-seq 数据处理平台 - 项目架构与进度说明

## 项目概述

本项目是一个单细胞RNA测序（scRNA-seq）数据标准化与前置处理平台，主要负责数据入库前的准备和审核工作。平台接收来自研究者的scRNA-seq数据集，经过结构化校验、基因名称对齐、细胞类型标准化等处理，输出标准化的metadata和表达矩阵供下游质量控制使用。

## 当前架构设计

### 技术栈
- **后端框架**: FastAPI
- **数据库**: SQLite（开发阶段）
- **数据处理**: scanpy + pandas + numpy
- **基因映射**: mygene.info API
- **细胞类型映射**: Zooma API
- **文件格式**: h5ad (AnnData)

### 核心模块

#### 1. 数据接收模块 (Upload Service)
- **功能**: 处理文件上传和分片合并
- **支持格式**: h5ad文件
- **特性**: 文件校验、大小限制、哈希验证
- **状态**: 基础功能已实现

#### 2. 数据校验模块 (Validation Service)
- **结构化校验**: 
  - h5ad文件格式验证
  - 必要字段检查（obs、var列）
  - 数据完整性验证
- **语义校验**:
  - 物种信息验证（当前支持小鼠）
  - 基因组版本检查
  - 元数据一致性验证
- **状态**: 核心校验逻辑已实现

#### 3. 基因映射模块 (Mapping Service)
- **功能**: 基因符号到Ensembl ID的标准化
- **数据源**: mygene.info API
- **策略**: 
  - 保留原始基因符号
  - 添加Ensembl ID映射
  - 处理映射失败和模糊匹配
- **状态**: API集成已完成，需要优化缓存机制

#### 4. 细胞类型标准化模块 (Mapping Service)
- **功能**: 细胞类型标签到CL Ontology的映射
- **数据源**: Zooma API
- **策略**:
  - 自由文本到标准CL ID的映射
  - 置信度评估
  - 允许未映射状态进入下游
- **状态**: API集成已完成，需要优化匹配算法

#### 5. 数据导出模块 (Export Service)
- **输出格式**: 
  - 标准化的h5ad文件
  - JSON格式处理报告
  - TSV格式映射详情
- **质量指标**: 计算基本统计信息
- **状态**: 导出功能已实现

#### 6. 任务管理模块
- **状态跟踪**: pending → uploading → processing → completed/failed
- **错误处理**: 详细的错误日志和状态更新
- **异步处理**: 使用FastAPI BackgroundTasks
- **状态**: 基础流程已实现

### API接口设计

#### 核心端点
- `POST /submissions` - 创建提交任务
- `POST /submissions/{id}/upload` - 上传h5ad文件
- `GET /submissions/{id}/status` - 查询处理状态
- `GET /submissions/{id}/report` - 下载处理报告
- `GET /submissions/{id}/export` - 下载处理结果

#### 数据契约
- **输入要求**: h5ad格式，包含obs和var元数据
- **必填字段**: cell_id, raw_cell_type_label, gene_symbol等
- **输出保证**: 标准化的metadata + 对齐后的表达矩阵

## 当前实现状态

### 已完成功能
1. **项目基础架构**: FastAPI应用框架搭建完成
2. **数据库设计**: SQLite表结构和模型定义完成
3. **文件上传**: 基础文件上传功能实现
4. **数据校验**: h5ad文件结构校验和语义检查
5. **基因映射**: mygene.info API集成
6. **细胞类型映射**: Zooma API集成
7. **数据导出**: 标准化输出和报告生成
8. **API接口**: 完整的REST API端点
9. **错误处理**: 异常捕获和状态管理
10. **测试框架**: 端到端测试脚本

### 当前问题
1. **处理流程稳定性**: 后台任务处理存在异常，需要进一步调试
2. **依赖包兼容性**: scanpy等包在某些环境下可能存在兼容性问题
3. **网络依赖**: 依赖外部API服务，需要容错机制
4. **性能优化**: 大文件处理效率需要提升
5. **错误信息**: 需要更详细的错误日志和调试信息

## 未来优化迭代方向

### Phase 2: 稳定性与性能优化

#### 1. 任务处理优化
- **队列系统**: 引入Celery + Redis实现真正的异步任务队列
- **任务重试**: 实现失败任务的重试机制
- **进度跟踪**: 实时处理进度反馈
- **资源管理**: 内存和CPU使用优化

#### 2. 数据映射优化
- **本地缓存**: 实现基因和细胞类型映射的本地缓存
- **批量处理**: 优化API调用，减少网络请求次数
- **映射规则**: 开发自定义映射规则和置信度模型
- **离线模式**: 支持无网络环境下的映射处理

#### 3. 错误处理增强
- **详细日志**: 完善错误日志和调试信息
- **错误分类**: 区分可恢复和不可恢复的错误
- **用户反馈**: 提供更友好的错误提示
- **监控告警**: 实现系统监控和异常告警

### Phase 3: 功能扩展

#### 1. 多格式支持
- **输入格式**: 支持MTX、Seurat RDS等格式
- **输出格式**: 支持多种下游分析工具格式
- **格式转换**: 实现格式间的自动转换

#### 2. 多物种支持
- **物种扩展**: 支持人类、果蝇等其他物种
- **基因组版本**: 支持多种基因组版本
- **参考数据库**: 集成更多参考数据库

#### 3. 质量控制增强
- **质量指标**: 实现更全面的质量评估
- **阈值设置**: 可配置的质量阈值
- **可视化**: 质量指标的可视化展示

### Phase 4: 用户界面与工作流

#### 1. 前端界面
- **Web界面**: 开发用户友好的Web界面
- **文件上传**: 拖拽上传和进度显示
- **结果展示**: 处理结果的图形化展示
- **历史记录**: 处理历史和结果管理

#### 2. 人工审核工作台
- **映射审核**: 低置信度映射的人工确认
- **批量操作**: 批量审核和批准
- **审核记录**: 审核历史和决策记录

#### 3. 工作流集成
- **API集成**: 与下游分析工具的API集成
- **自动化流程**: 端到端的自动化处理流程
- **通知系统**: 处理完成通知和状态更新

### Phase 5: 企业级特性

#### 1. 安全与权限
- **用户认证**: 用户登录和权限管理
- **数据安全**: 敏感数据的加密和脱敏
- **访问控制**: 基于角色的访问控制

#### 2. 可扩展性
- **微服务架构**: 拆分为多个微服务
- **容器化**: Docker容器化部署
- **云原生**: 支持Kubernetes等云原生平台

#### 3. 监控与运维
- **性能监控**: 系统性能监控和优化
- **日志管理**: 集中化日志管理
- **备份恢复**: 数据备份和灾难恢复

## 技术债务与改进点

### 当前技术债务
1. **硬编码配置**: 将配置参数提取到配置文件
2. **错误处理**: 统一错误处理机制
3. **代码重构**: 模块间的耦合度需要降低
4. **测试覆盖**: 增加单元测试和集成测试
5. **文档完善**: API文档和用户手册

### 架构改进建议
1. **分层架构**: 实现更清晰的分层架构
2. **依赖注入**: 使用依赖注入降低耦合
3. **配置管理**: 环境配置和参数管理
4. **缓存策略**: 实现多级缓存策略
5. **数据库优化**: 索引优化和查询优化

## 总结

当前项目已完成核心功能的实现，具备了基本的scRNA-seq数据处理能力。主要的技术架构合理，模块划分清晰，为后续扩展奠定了良好基础。

下一步的重点应该是解决当前的处理稳定性问题，优化性能，并逐步扩展功能。建议按照Phase 2的规划，优先解决任务处理的稳定性问题，然后逐步实现功能扩展和用户体验优化。

项目的长期目标是构建一个完整、稳定、易用的scRNA-seq数据处理平台，为生物信息学研究提供可靠的数据处理服务。
